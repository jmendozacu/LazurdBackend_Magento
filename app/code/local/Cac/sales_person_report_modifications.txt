# create journal table
create table sales_flat_order_journal
(
  entity_id                                 int unsigned auto_increment comment 'Entity Id'
    primary key,
  state                                     varchar(32)                      null comment 'State',
  status                                    varchar(32)                      null comment 'Status',
  coupon_code                               varchar(255)                     null comment 'Coupon Code',
  protect_code                              varchar(255)                     null comment 'Protect Code',
  shipping_description                      varchar(255)                     null comment 'Shipping Description',
  is_virtual                                smallint(5) unsigned             null comment 'Is Virtual',
  store_id                                  smallint(5) unsigned             null comment 'Store Id',
  customer_id                               int unsigned                     null comment 'Customer Id',
  base_discount_amount                      decimal(12, 4)                   null comment 'Base Discount Amount',
  base_discount_canceled                    decimal(12, 4)                   null comment 'Base Discount Canceled',
  base_discount_invoiced                    decimal(12, 4)                   null comment 'Base Discount Invoiced',
  base_discount_refunded                    decimal(12, 4)                   null comment 'Base Discount Refunded',
  base_grand_total                          decimal(12, 4)                   null comment 'Base Grand Total',
  base_shipping_amount                      decimal(12, 4)                   null comment 'Base Shipping Amount',
  base_shipping_canceled                    decimal(12, 4)                   null comment 'Base Shipping Canceled',
  base_shipping_invoiced                    decimal(12, 4)                   null comment 'Base Shipping Invoiced',
  base_shipping_refunded                    decimal(12, 4)                   null comment 'Base Shipping Refunded',
  base_shipping_tax_amount                  decimal(12, 4)                   null comment 'Base Shipping Tax Amount',
  base_shipping_tax_refunded                decimal(12, 4)                   null comment 'Base Shipping Tax Refunded',
  base_subtotal                             decimal(12, 4)                   null comment 'Base Subtotal',
  base_subtotal_canceled                    decimal(12, 4)                   null comment 'Base Subtotal Canceled',
  base_subtotal_invoiced                    decimal(12, 4)                   null comment 'Base Subtotal Invoiced',
  base_subtotal_refunded                    decimal(12, 4)                   null comment 'Base Subtotal Refunded',
  base_tax_amount                           decimal(12, 4)                   null comment 'Base Tax Amount',
  base_tax_canceled                         decimal(12, 4)                   null comment 'Base Tax Canceled',
  base_tax_invoiced                         decimal(12, 4)                   null comment 'Base Tax Invoiced',
  base_tax_refunded                         decimal(12, 4)                   null comment 'Base Tax Refunded',
  base_to_global_rate                       decimal(12, 4)                   null comment 'Base To Global Rate',
  base_to_order_rate                        decimal(12, 4)                   null comment 'Base To Order Rate',
  base_total_canceled                       decimal(12, 4)                   null comment 'Base Total Canceled',
  base_total_invoiced                       decimal(12, 4)                   null comment 'Base Total Invoiced',
  base_total_invoiced_cost                  decimal(12, 4)                   null comment 'Base Total Invoiced Cost',
  base_total_offline_refunded               decimal(12, 4)                   null comment 'Base Total Offline Refunded',
  base_total_online_refunded                decimal(12, 4)                   null comment 'Base Total Online Refunded',
  base_total_paid                           decimal(12, 4)                   null comment 'Base Total Paid',
  base_total_qty_ordered                    decimal(12, 4)                   null comment 'Base Total Qty Ordered',
  base_total_refunded                       decimal(12, 4)                   null comment 'Base Total Refunded',
  discount_amount                           decimal(12, 4)                   null comment 'Discount Amount',
  discount_canceled                         decimal(12, 4)                   null comment 'Discount Canceled',
  discount_invoiced                         decimal(12, 4)                   null comment 'Discount Invoiced',
  discount_refunded                         decimal(12, 4)                   null comment 'Discount Refunded',
  grand_total                               decimal(12, 4)                   null comment 'Grand Total',
  shipping_amount                           decimal(12, 4)                   null comment 'Shipping Amount',
  shipping_canceled                         decimal(12, 4)                   null comment 'Shipping Canceled',
  shipping_invoiced                         decimal(12, 4)                   null comment 'Shipping Invoiced',
  shipping_refunded                         decimal(12, 4)                   null comment 'Shipping Refunded',
  shipping_tax_amount                       decimal(12, 4)                   null comment 'Shipping Tax Amount',
  shipping_tax_refunded                     decimal(12, 4)                   null comment 'Shipping Tax Refunded',
  store_to_base_rate                        decimal(12, 4)                   null comment 'Store To Base Rate',
  store_to_order_rate                       decimal(12, 4)                   null comment 'Store To Order Rate',
  subtotal                                  decimal(12, 4)                   null comment 'Subtotal',
  subtotal_canceled                         decimal(12, 4)                   null comment 'Subtotal Canceled',
  subtotal_invoiced                         decimal(12, 4)                   null comment 'Subtotal Invoiced',
  subtotal_refunded                         decimal(12, 4)                   null comment 'Subtotal Refunded',
  tax_amount                                decimal(12, 4)                   null comment 'Tax Amount',
  tax_canceled                              decimal(12, 4)                   null comment 'Tax Canceled',
  tax_invoiced                              decimal(12, 4)                   null comment 'Tax Invoiced',
  tax_refunded                              decimal(12, 4)                   null comment 'Tax Refunded',
  total_canceled                            decimal(12, 4)                   null comment 'Total Canceled',
  total_invoiced                            decimal(12, 4)                   null comment 'Total Invoiced',
  total_offline_refunded                    decimal(12, 4)                   null comment 'Total Offline Refunded',
  total_online_refunded                     decimal(12, 4)                   null comment 'Total Online Refunded',
  total_paid                                decimal(12, 4)                   null comment 'Total Paid',
  total_qty_ordered                         decimal(12, 4)                   null comment 'Total Qty Ordered',
  total_refunded                            decimal(12, 4)                   null comment 'Total Refunded',
  can_ship_partially                        smallint(5) unsigned             null comment 'Can Ship Partially',
  can_ship_partially_item                   smallint(5) unsigned             null comment 'Can Ship Partially Item',
  customer_is_guest                         smallint(5) unsigned             null comment 'Customer Is Guest',
  customer_note_notify                      smallint(5) unsigned             null comment 'Customer Note Notify',
  billing_address_id                        int                              null comment 'Billing Address Id',
  customer_group_id                         smallint(6)                      null comment 'Customer Group Id',
  edit_increment                            int                              null comment 'Edit Increment',
  email_sent                                smallint(5) unsigned             null comment 'Email Sent',
  forced_shipment_with_invoice              smallint(5) unsigned             null comment 'Forced Do Shipment With Invoice',
  payment_auth_expiration                   int                              null comment 'Payment Authorization Expiration',
  quote_address_id                          int                              null comment 'Quote Address Id',
  quote_id                                  int                              null comment 'Quote Id',
  shipping_address_id                       int                              null comment 'Shipping Address Id',
  adjustment_negative                       decimal(12, 4)                   null comment 'Adjustment Negative',
  adjustment_positive                       decimal(12, 4)                   null comment 'Adjustment Positive',
  base_adjustment_negative                  decimal(12, 4)                   null comment 'Base Adjustment Negative',
  base_adjustment_positive                  decimal(12, 4)                   null comment 'Base Adjustment Positive',
  base_shipping_discount_amount             decimal(12, 4)                   null comment 'Base Shipping Discount Amount',
  base_subtotal_incl_tax                    decimal(12, 4)                   null comment 'Base Subtotal Incl Tax',
  base_total_due                            decimal(12, 4)                   null comment 'Base Total Due',
  payment_authorization_amount              decimal(12, 4)                   null comment 'Payment Authorization Amount',
  shipping_discount_amount                  decimal(12, 4)                   null comment 'Shipping Discount Amount',
  subtotal_incl_tax                         decimal(12, 4)                   null comment 'Subtotal Incl Tax',
  total_due                                 decimal(12, 4)                   null comment 'Total Due',
  weight                                    decimal(12, 4)                   null comment 'Weight',
  customer_dob                              datetime                         null comment 'Customer Dob',
  increment_id                              varchar(50)                      null comment 'Increment Id',
  applied_rule_ids                          varchar(255)                     null comment 'Applied Rule Ids',
  base_currency_code                        varchar(3)                       null comment 'Base Currency Code',
  customer_email                            varchar(255)                     null comment 'Customer Email',
  customer_firstname                        varchar(255)                     null comment 'Customer Firstname',
  customer_lastname                         varchar(255)                     null comment 'Customer Lastname',
  customer_middlename                       varchar(255)                     null comment 'Customer Middlename',
  customer_prefix                           varchar(255)                     null comment 'Customer Prefix',
  customer_suffix                           varchar(255)                     null comment 'Customer Suffix',
  customer_taxvat                           varchar(255)                     null comment 'Customer Taxvat',
  discount_description                      varchar(255)                     null comment 'Discount Description',
  ext_customer_id                           varchar(255)                     null comment 'Ext Customer Id',
  ext_order_id                              varchar(255)                     null comment 'Ext Order Id',
  global_currency_code                      varchar(3)                       null comment 'Global Currency Code',
  hold_before_state                         varchar(255)                     null comment 'Hold Before State',
  hold_before_status                        varchar(255)                     null comment 'Hold Before Status',
  order_currency_code                       varchar(255)                     null comment 'Order Currency Code',
  original_increment_id                     varchar(50)                      null comment 'Original Increment Id',
  relation_child_id                         varchar(32)                      null comment 'Relation Child Id',
  relation_child_real_id                    varchar(32)                      null comment 'Relation Child Real Id',
  relation_parent_id                        varchar(32)                      null comment 'Relation Parent Id',
  relation_parent_real_id                   varchar(32)                      null comment 'Relation Parent Real Id',
  remote_ip                                 varchar(255)                     null comment 'Remote Ip',
  shipping_method                           varchar(255)                     null comment 'Shipping Method',
  store_currency_code                       varchar(3)                       null comment 'Store Currency Code',
  store_name                                varchar(255)                     null comment 'Store Name',
  x_forwarded_for                           varchar(255)                     null comment 'X Forwarded For',
  customer_note                             text                             null comment 'Customer Note',
  created_at                                timestamp                        null comment 'Created At',
  updated_at                                timestamp                        null comment 'Updated At',
  total_item_count                          smallint(5) unsigned default 0   not null comment 'Total Item Count',
  customer_gender                           int                              null comment 'Customer Gender',
  hidden_tax_amount                         decimal(12, 4)                   null comment 'Hidden Tax Amount',
  base_hidden_tax_amount                    decimal(12, 4)                   null comment 'Base Hidden Tax Amount',
  shipping_hidden_tax_amount                decimal(12, 4)                   null comment 'Shipping Hidden Tax Amount',
  base_shipping_hidden_tax_amnt             decimal(12, 4)                   null comment 'Base Shipping Hidden Tax Amount',
  hidden_tax_invoiced                       decimal(12, 4)                   null comment 'Hidden Tax Invoiced',
  base_hidden_tax_invoiced                  decimal(12, 4)                   null comment 'Base Hidden Tax Invoiced',
  hidden_tax_refunded                       decimal(12, 4)                   null comment 'Hidden Tax Refunded',
  base_hidden_tax_refunded                  decimal(12, 4)                   null comment 'Base Hidden Tax Refunded',
  shipping_incl_tax                         decimal(12, 4)                   null comment 'Shipping Incl Tax',
  base_shipping_incl_tax                    decimal(12, 4)                   null comment 'Base Shipping Incl Tax',
  coupon_rule_name                          varchar(255)                     null comment 'Coupon Sales Rule Name',
  paypal_ipn_customer_notified              int                  default 0   null comment 'Paypal Ipn Customer Notified',
  gift_message_id                           int                              null comment 'Gift Message Id',
  webpos_order_id                           text                             null,
  webpos_delivery_date                      text                             null,
  location_id                               text                             null,
  webpos_change                             decimal(12, 4)                   null,
  webpos_base_change                        decimal(12, 4)                   null,
  webpos_staff_id                           int(11) unsigned                 null,
  webpos_staff_name                         text                             null,
  webpos_till_id                            int(11) unsigned                 null,
  kitchen_user_ids                          varchar(255)                     null,
  order_status                              varchar(255)                     null,
  driver_id                                 varchar(255)                     null,
  is_survey                                 int(11) unsigned     default 2   not null,
  is_customer_notify                        varchar(255)         default '2' null,
  is_delay_notify                           int(11) unsigned     default 0   not null,
  shipping_arrival_date                     varchar(255)                     null,
  shipping_arrival_comments                 text                             null,
  shipping_arrival_time_slot                int                              null,
  shipping_delivery_date                    datetime                         null,
  customercredit_discount                   decimal(12, 4)                   null,
  base_customercredit_discount              decimal(12, 4)                   null,
  base_customercredit_discount_for_shipping decimal(12, 4)                   null,
  customercredit_discount_for_shipping      decimal(12, 4)                   null,
  base_customercredit_hidden_tax            decimal(12, 4)                   null,
  customercredit_hidden_tax                 decimal(12, 4)                   null,
  base_customercredit_shipping_hidden_tax   decimal(12, 4)                   null,
  customercredit_shipping_hidden_tax        decimal(12, 4)                   null,
  original_webpos_staff_id                  int                  default -1  not null
)
  comment 'Sales Flat Order Journal';



# SFO_CLONE
    CREATE TRIGGER sfo_clone AFTER INSERT ON sales_flat_order
    FOR EACH ROW BEGIN
        INSERT INTO sales_flat_order_journal select * from sales_flat_order where entity_id = NEW.entity_id;
    END;

#sfo_clone_update_subtotal_invoiced
    DELIMITER //
    CREATE TRIGGER sfo_clone_update_subtotal_invoiced AFTER UPDATE ON sales_flat_order
    FOR EACH ROW BEGIN
        update sales_flat_order_journal set subtotal_invoiced=NEW.subtotal_invoiced where entity_id=new.entity_id;
    END;
DELIMITER ;


